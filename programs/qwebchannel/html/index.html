<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>King James Pure Bible Search Standalone Server</title>
		<link rel="stylesheet" href="jquery/jquery-ui/1.11.4/themes/start/jquery-ui.css">
		<script src="jquery/jquery-1.11.3.js"></script>
		<script src="jquery/jquery-ui/1.11.4/jquery-ui.js"></script>
		<script type="text/javascript" src="./qwebchannel.js"></script>
		<script type="text/javascript">
			var bEnableScriptureBrowserTabSwap = false;
			var nSearchPhraseCount = 0;
			var nSearchPhraseNextID = 0;

			//BEGIN SETUP
			function output(message)
			{
				var output = document.getElementById("output");
				output.innerHTML = output.innerHTML + message + "\n";
			}
			function makeRelIndex(book, chapter, verse, word)
			{
				return ((book & 0xFF) << 24) |
						((chapter & 0xFF) << 16) |
						((verse & 0xFF) << 8) |
						(word & 0xFF);
			}
			function relIndexBook(ndxRel)
			{
				return ((ndxRel >> 24) & 0xFF);
			}
			function relIndexChapter(ndxRel)
			{
				return ((ndxRel >> 16) & 0xFF);
			}
			function relIndexVerse(ndxRel)
			{
				return ((ndxRel >> 8) & 0xFF);
			}
			function relIndexWord(ndxRel)
			{
				return (ndxRel & 0xFF);
			}
			function scrollTabTop()
			{
				$("html, #tabs").animate({
					scrollTop: 0
				}, 200);
			}
			function doGetCaretPosition(oField) {
				var iCaretPos = 0;

				// IE Support
				if (document.selection) {
					// Set focus on the element
					oField.focus();

					// To get cursor position, get empty selection range
					var oSel = document.selection.createRange();

					// Move selection start to 0 position
					oSel.moveStart('character', -oField.value.length);

					// The caret position is selection length
					iCaretPos = oSel.text.length;
				}
				// Firefox support
				else if (oField.selectionStart || oField.selectionStart == '0') {
					iCaretPos = ((oField.selectionDirection=='backward') ? oField.selectionStart : oField.selectionEnd);
				}
				// Else fallback to field length
				else {
					iCaretPos = oField.value.length;
				}

				return (iCaretPos);
			}
			function scrollToAnchor(anAnchor)
			{
				var element_to_scroll_to = document.getElementById(anAnchor);
				element_to_scroll_to.scrollIntoView();
			}
			window.onload = function() {
				var baseUrl = (/[?&]webChannelBaseUrl=([A-Za-z0-9\-:/\.]+)/.exec(location.search)[1]);
				output("Connecting to WebSocket server at " + baseUrl + ".");
				var socket = new WebSocket(baseUrl);

				socket.onclose = function()
				{
					output("WebChannel Connection Closed");
					alert("WebChannel Connection Closed");
				};
				socket.onerror = function(error)
				{
					output("WebChannel Error: " + error);
					alert("WebChannel Error: " + error);
				};
				socket.onopen = function()
				{
					output("WebSocket connected, setting up QWebChannel.");
					new QWebChannel(socket, function(channel) {
						// make our kjpbs object accessible globally
						window.kjpbs = channel.objects.kjpbs;

						kjpbs.searchResultsChanged.connect(function(strHtmlLiSearchResults) {
							document.getElementById("searchResults").innerHTML = strHtmlLiSearchResults;
							$("#tabs").tabs("option", "active", 0);
							$("#tabs").tabs("refresh");
							scrollTabTop();
							// Wait cursor back off
							$("body").css("cursor", "default");
						});

						kjpbs.scriptureBrowserRender.connect(function(ndxRel, strHtmlScripture) {
							document.getElementById("scriptureText").innerHTML = strHtmlScripture;
							if (bEnableScriptureBrowserTabSwap) {
								$("#tabs").tabs("option", "active", 1);
								$("#tabs").tabs("refresh");
								scrollToAnchor(ndxRel);
							}
							// Select the text from the navigation:
							$("#" + ndxRel).addClass("selected");
							$("#" + ndxRel).next().addClass("selected");
							// Wait cursor back off
							$("body").css("cursor", "default");
						});

						kjpbs.setAutoCorrectText.connect(function(strElementID, strAC) {
							document.getElementById(strElementID+"_AC").innerHTML = "&nbsp;" + strAC;
						});

						bEnableScriptureBrowserTabSwap = false;
						kjpbs.gotoIndex(makeRelIndex(1, 1, 0, 0));
						$("#tabs").tabs("option", "active", 1);
						$("#tabs").tabs("refresh");
						scrollTabTop();

						output("Connected to WebChannel, ready to send/receive searches!");
					});
				}
			}
			//END SETUP

			function addSearchPhrase() {
				nSearchPhraseCount = nSearchPhraseCount + 1;
				nSearchPhraseNextID = nSearchPhraseNextID + 1;
				var newPhrase = $("#phrases").append(document.createElement('div'));
				newPhrase.attr("id", "searchPhrase_" + nSearchPhraseNextID);
				newPhrase.append('<p class="searchPhraseAC" id="searchPhrase_' + nSearchPhraseNextID + '_AC">&nbsp;</p>');
				newPhrase.append('<input class="searchPhraseText" id="searchPhrase_' + nSearchPhraseNextID + '_Text" type="text" onchange="javascript:searchPhraseChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');" />')
							.on('change keyup paste input', function() { searchPhraseTextChanged(this.id); });
				$("#tabs").tabs("refresh");
			}

			function searchPhraseChanged(aSearchPhrase) {
				var input = document.getElementById(aSearchPhrase+"_Text");
				var text = input.value;
				if (!text) {
					document.getElementById("searchResults").innerHTML = "";
					$("#tabs").tabs("option", "active", 0);
					$("#tabs").tabs("refresh");
					scrollTabTop();
					return;
				}

				$("body").css("cursor", "progress");
				window.kjpbs.setSearchPhrases(text);
			}

			function searchPhraseTextChanged(aSearchPhrase) {
				var input = document.getElementById(aSearchPhrase+"_Text");
				var thePhrase = document.getElementById(aSearchPhrase+"_AC");
				var text = input.value;
				if (!text) {
					thePhrase.innerHTML = "&nbsp;";
				} else {
					window.kjpbs.autoCorrect(aSearchPhrase, text, doGetCaretPosition(input));
				}
			}

			function gotoIndex(ndx)
			{
				bEnableScriptureBrowserTabSwap = true;
				$("body").css("cursor", "progress");
				window.kjpbs.gotoIndex(ndx);
			}

			function checkKey(e) {

				e = e || window.event;

				if (e.altKey) {
					switch (e.keyCode) {
						case 37:		// Left arrow
							$("#tabs").tabs("option", "active",
									(($("#tabs").tabs("option", "active") == 0) ?
											$("#tabs").tabs("option", "active", 1) :
											$("#tabs").tabs("option", "active", $("#tabs").tabs("option", "active")-1)));
							break;
						case 39:		// Right arrow
							$("#tabs").tabs("option", "active",
									(($("#tabs").tabs("option", "active") == 1) ?
											$("#tabs").tabs("option", "active", 0) :
											$("#tabs").tabs("option", "active", $("#tabs").tabs("option", "active")+1)));
							break;
						// Note: up=38, down=40
						default:
							return;
					}
					e.preventDefault();
				}
			}
			document.onkeydown = checkKey;
		</script>
		<style type="text/css">
			html {
				height: 100%;
				width: 100%;
			}

			.book { font-size:xx-large; font-weight:bold; }
			.chapter { font-size:x-large; font-weight:bold; }
			.subtitle { font-size:medium; font-weight:normal; font-style:italic; }
			.category { font-size:medium; font-weight:normal; }
			.superscription { font-size:medium; font-weight:normal; font-style:italic; }
			.colophon { font-size:medium; font-weight:normal; font-style:italic; }

			.selected { background:LightGoldenRodYellow; }

			.searchPhraseAC {
				width: 500px;
				margin: 0 10px 0 0;
			}
			.searchPhraseText {
				width: 500px;
				margin: 0 10px 0 0;
			}

			#output {
				width: 500px;
				height: 75px;
			}
			#searchResults {
				list-style-type: none;
				width: 90%;
				min-height: 300px;
				max-height: auto;
			}
			#scriptureText {
				width: 90%;
				min-height: 300px;
				max-height: auto;
				margin: 0 auto;
			}
		</style>
	</head>
	<body>
		<div id="status">
			<h1>King James Pure Bible Search</h1>
			<h2>Standalone Server</h2>
			<textarea id="output"></textarea><br />
		</div>

		<div id="tabs">
			<ul>
				<li><a href="#search"><span>Search</span></a></li>
				<li><a href="#browser"><span>Scripture Browser</span></a></li>
			</ul>

			<div id="search">
				<div id="phrases"></div>
				<ol id="searchResults"></ol>
			</div>

			<div id="browser">
				<div id="scriptureText">
				</div>
			</div>
		</div>

		<script>
			$( "#tabs" ).tabs();
			addSearchPhrase();			// Add initial search phrase
		</script>


	</body>
</html>
