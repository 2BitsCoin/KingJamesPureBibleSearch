<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>King James Pure Bible Search WebChannel Server</title>
		<link rel="stylesheet" type="text/css" href="jquery/jquery-ui/1.11.4/themes/start/jquery-ui.min.css" />
		<script type="text/javascript" src="jquery/jquery-1.11.3.min.js"></script>
		<script type="text/javascript" src="jquery/jquery-ui/1.11.4/jquery-ui.min.js"></script>
		<script type="text/javascript" src="jquery/jquery-ui/jquery-ui-autocomplete-scroll/0.1.7/jquery.ui.autocomplete.scroll.min.js"></script>
		<link rel="stylesheet" type="text/css" href="jquery/jquery-ui/fancytree/dist/skin-themeroller/ui.fancytree.min.css" />
		<script type="text/javascript" src="jquery/jquery-ui/fancytree/dist/jquery.fancytree-all.min.js"></script>

		<script type="text/javascript" src="./qwebchannel.js"></script>
		<script type="text/javascript">
			var nSearchPhraseCount = 0;
			var nSearchPhraseNextID = 0;
//			var ndxBrowserCurrent;				// Current Scripture Browser Index
			var nBrowserChapterCurrent = 0;		// Current Scripture Browser Chapter (1 through n, 0 = not init)
			var bkChpStruct;					// Book/Chapter layout for navigation

			//BEGIN SETUP
			function output(message)
			{
				var output = document.getElementById("output");
				output.innerHTML = output.innerHTML + message + "\n";
			}
			function hideKeyboard() {
				//this set timeout needed for case when hideKeyborad
				//is called inside of 'onfocus' event handler
				setTimeout(function() {
					//creating temp field
					var field = document.createElement('input');
					field.setAttribute('type', 'text');
					//hiding temp field from peoples eyes
					//-webkit-user-modify is nessesary for Android 4.x
					field.setAttribute('style', 'position:absolute; top: 0px; opacity: 0; -webkit-user-modify: read-write-plaintext-only; left:0px;');
					document.body.appendChild(field);

					//adding onfocus event handler for out temp field
					field.onfocus = function(){
						//this timeout of 200ms is nessasary for Android 2.3.x
						setTimeout(function() {

							field.setAttribute('style', 'display:none;');
							setTimeout(function() {
								document.body.removeChild(field);
								document.body.focus();
							}, 14);
						}, 200);
					};

					//focusing it
					field.focus();
				}, 50);
			}
			function waitCursor(bAreBusy) {
				if (bAreBusy) {
					$("body").css("cursor", "progress");
				} else {
					$("body").css("cursor", "default");
				}
			}
			function makeRelIndex(book, chapter, verse, word)
			{
				return ((book & 0xFF) << 24) |
						((chapter & 0xFF) << 16) |
						((verse & 0xFF) << 8) |
						(word & 0xFF);
			}
			function relIndexBook(ndxRel)
			{
				return ((ndxRel >> 24) & 0xFF);
			}
			function relIndexChapter(ndxRel)
			{
				return ((ndxRel >> 16) & 0xFF);
			}
			function relIndexVerse(ndxRel)
			{
				return ((ndxRel >> 8) & 0xFF);
			}
			function relIndexWord(ndxRel)
			{
				return (ndxRel & 0xFF);
			}
			function scrollTabTop()
			{
				$("html, #tabs").animate({
					scrollTop: 0
				}, 200);
			}
			function doGetCaretPosition(oField) {
				var iCaretPos = 0;

				// IE Support
				if (document.selection) {
					// Set focus on the element
					oField.focus();

					// To get cursor position, get empty selection range
					var oSel = document.selection.createRange();

					// Move selection start to 0 position
					oSel.moveStart('character', -oField.value.length);

					// The caret position is selection length
					iCaretPos = oSel.text.length;
				}
				// Firefox support
				else if (oField.selectionStart || oField.selectionStart == '0') {
					iCaretPos = ((oField.selectionDirection=='backward') ? oField.selectionStart : oField.selectionEnd);
				}
				// Else fallback to field length
				else {
					iCaretPos = oField.value.length;
				}

				return (iCaretPos);
			}
			function scrollToAnchor(anAnchor)
			{
				var element_to_scroll_to = document.getElementById(anAnchor);
				if (element_to_scroll_to)
					element_to_scroll_to.scrollIntoView();
			}
			function closeAllAutoCompleters()
			{
				$(".searchPhraseText").each(function(i, obj) {
					$("#"+this.id).autocomplete("close");
				});
			}
			function enableAllAutoCompleters()
			{
				$(".searchPhraseText").each(function(i, obj) {
					$("#"+this.id).autocomplete("enable");
				});
			}
			function disableAllAutoCompleters()
			{
				$(".searchPhraseText").each(function(i, obj) {
					$("#"+this.id).autocomplete("disable");
				});
			}
			function getSearchWithin()
			{
				var tree = $("#searchWithinTree").fancytree("getTree");
				var root = tree.getFirstChild();

				if (root && (root.isSelected())) {
					return ("");			// Empty string means entire Bible (shortcut)
				} else {
					// Get a list of all selected nodes in searchWithin tree, and convert to a key array:
					var selKeys = $.map(tree.getSelectedNodes(), function(node) {
						if (node.key.indexOf("_") === -1) return node.key;
					});
					if (selKeys.length > 0) {
						return (selKeys.join(","));
					} else {
						return ("-");		// Special mode for "nothing selected"
					}
				}
			}
			window.onload = function() {
				var baseUrl = (/[?&]webChannelBaseUrl=([A-Za-z0-9\-:/\.]+)/.exec(location.search)[1]);
				output("Connecting to WebSocket server at " + baseUrl + ".");
				var socket = new WebSocket(baseUrl);

				socket.onclose = function()
				{
					document.getElementById("status").style.display = 'block';
					output("WebChannel Connection Closed");
					alert("WebChannel Connection Closed");
				};
				socket.onerror = function(error)
				{
					document.getElementById("status").style.display = 'block';
					output("WebChannel Error: " + error);
					alert("WebChannel Error: " + error);
				};
				socket.onopen = function()
				{
					output("WebSocket connected, setting up QWebChannel.");
					new QWebChannel(socket, function(channel) {
						// make our kjpbs object accessible globally
						window.kjpbs = channel.objects.kjpbs;

						kjpbs.bibleSelected.connect(function(bSuccess, strJsonBkChpStruct) {
							if (!bSuccess) {
								output("Bible failed to load");
								alert("Specified Bible is Not Currently Available on the Server!");
							} else {
								output("Bible Successfully Selected");
								bkChpStruct = $.parseJSON(strJsonBkChpStruct);
							}
						});

						kjpbs.searchWithinModelChanged.connect(function(strJsonSearchWithinTree, nSearchScopeMode) {
							var tree = $("#searchWithinTree").fancytree("getTree");
							tree.reload($.parseJSON(strJsonSearchWithinTree));
							$('#searchScope').val(nSearchScopeMode);
							$("#searchScope").selectmenu("refresh");
						});

						kjpbs.broadcast.connect(function(strMessage) {
							if (strMessage) {
								alert(strMessage);
							}
						});

						kjpbs.searchResultsChanged.connect(function(strHtmlSearchResults, strHtmlSummary, strlstOccurrences) {
							document.getElementById("searchResults").innerHTML = strHtmlSearchResults;
							document.getElementById("searchResultsSummary").innerHTML = strHtmlSummary;

							var lstOccurrences = strlstOccurrences.split(";");
							var ndxOccurrences = 0;
							$(".searchPhraseText").each(function(i) {
								if ((this.value) &&
									(!document.getElementById($(this).parents(".searchPhrase").attr("id")+"_Disable").checked) &&
									(ndxOccurrences < lstOccurrences.length)) {
									document.getElementById($(this).parents(".searchPhrase").attr("id")+"_Occurrences").innerHTML = lstOccurrences[ndxOccurrences];
									ndxOccurrences = ndxOccurrences + 1;
								}
							});

							$("#tabs").tabs("option", "active", 0);
							$("#tabs").tabs("refresh");
//							scrollTabTop();
							// Wait cursor back off
							waitCursor(false);
//							enableAllAutoCompleters();
							closeAllAutoCompleters();
							disableAllAutoCompleters();
						});

						kjpbs.scriptureBrowserRender.connect(function(nChp, ndxRel, strHtmlScripture, strParam) {
// ndxBrowserCurrent is obsolete (doesn't make much sense) if we employ caching:
//							ndxBrowserCurrent = ndxRel;

							addPage(nChp, strHtmlScripture);

							var opts = strParam.split(",");
							// Select the text from the navigation if 'highlightAnchor' option and anchor is valid:
							if ($.inArray("highlightAnchor", opts) > -1) {
								highlightAnchor(ndxRel);
							}
							if ($.inArray("noturn", opts) == -1) {
								turnToPage(nChp);

								$("#tabs").tabs("option", "active", 1);
								$("#tabs").tabs("refresh");
								if ($.inArray("highlightAnchor", opts) > -1) {
									scrollToAnchor(ndxRel);
								} else if ($.inArray("scrollTabTop", opts) > -1) {
									scrollTabTop();
								}
							}
							// Wait cursor back off
							waitCursor(false);
						});

						kjpbs.setAutoCorrectText.connect(function(strElementID, strAC) {
							document.getElementById(strElementID+"_AC").innerHTML = "&nbsp;" + strAC;
							$("#"+strElementID+"_Text").autocomplete("enable");
						});

						kjpbs.setAutoCompleter.connect(function(strElementID, strlstCompleter) {
							$("#"+strElementID+"_Text").autocomplete("option", "source", strlstCompleter.split(";"));
						});

						kjpbs.updatePhrase.connect(function(strElementID, strNewPhrase) {
							document.getElementById(strElementID+"_Text").value = strNewPhrase;
							searchPhraseChanged(strElementID);
						});

						output("Connected to WebChannel, ready to send/receive searches!");

						output("Selecting Bible...");
						kjpbs.selectBible("85D8A6B0-E670-11E2-A28F-0800200C9A66");

						hideKeyboard();
						kjpbs.gotoIndex(0, 1, "scrollTabTop");
					});

					// Close heading after 5 seconds to get it out of the way on mobile devices:
					setTimeout(function()
					{
						document.getElementById("status").style.display = 'none';
					}, 5000);
				}
			}
			//END SETUP

			function addSearchPhrase() {
				document.getElementById("addSearchPhraseButton").blur();	// Workaround jqueryui bug
				$("#addSearchPhraseButton").removeClass('ui-state-focus ui-state-hover ui-state-active');

				nSearchPhraseCount = nSearchPhraseCount + 1;
				nSearchPhraseNextID = nSearchPhraseNextID + 1;
				$("#phrases").append('<div class="searchPhrase" id="searchPhrase_' + nSearchPhraseNextID + '"></div>');
				var newPhrase = $("#searchPhrase_" + nSearchPhraseNextID);
				newPhrase.append('<table class="searchPhraseTable" id="searchPhrase_' + nSearchPhraseNextID + '_Table"></table>');
				var phraseTable = $("#searchPhrase_" + nSearchPhraseNextID + "_Table");
				phraseTable.append('<tr></tr>');
				var trOccurrences = phraseTable.find("tr").first();
				trOccurrences.append('<td colspan="4"></td>');
				var tdOccurrences = trOccurrences.find("td").first();
				if (($(window).width() < 512) || ($(window).height() < 512)) {
					tdOccurrences.append('<label for="searchPhrase_' + nSearchPhraseNextID + '_Occurrences">Occurrences:&nbsp;</label><div class="searchPhraseOccurrences" id="searchPhrase_' + nSearchPhraseNextID + '_Occurrences">N/A</div>');
				} else {
					tdOccurrences.append('<label for="searchPhrase_' + nSearchPhraseNextID + '_Occurrences">Number of Occurrences:&nbsp;</label><div class="searchPhraseOccurrences" id="searchPhrase_' + nSearchPhraseNextID + '_Occurrences">N/A</div>');
				}
				phraseTable.append('<tr></tr>');
				var trAC = phraseTable.find("tr").first().next();
				trAC.append('<td class="expand"></td>');
				trAC.append('<td>&nbsp;</td>');
				trAC.append('<td></td>');
				trAC.append('<td></td>');
				var tdAC = trAC.find("td").first();
				tdAC.append('<p class="searchPhraseAC" id="searchPhrase_' + nSearchPhraseNextID + '_AC">&nbsp;</p>');
				phraseTable.append('<tr></tr>');
				var trInput = phraseTable.find("tr").first().next().next();
				trInput.append('<td class="expand"></td>');
				trInput.append('<td>&nbsp;</td>');
				trInput.append('<td></td>');
				trInput.append('<td></td>');
				var tdInput = trInput.find("td").first();
				tdInput.append('<input class="searchPhraseText" id="searchPhrase_' + nSearchPhraseNextID + '_Text" type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" onchange="javascript:searchPhraseChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');" />')
							.on('change keyup paste input', function() { searchPhraseTextChanged($(this).parents(".searchPhrase").attr("id")); });
				var tdBesome = trInput.find("td").first().next().next();
				tdBesome.append('<input type="image" value="Clear" class="searchPhraseBesome" id="searchPhrase_' + nSearchPhraseNextID + '_Besome" src="edit_clear.png" onclick="javascript:searchPhraseBesome(\'searchPhrase_' + nSearchPhraseNextID + '\');" />');
				var tdClose = trInput.find("td").first().next().next().next();
				tdClose.append('<input type="image" value="Close" class="searchPhraseClose" id="searchPhrase_' + nSearchPhraseNextID + '_Close" src="Close.png" onclick="javascript:searchPhraseClose(\'searchPhrase_' + nSearchPhraseNextID + '\');" />');
				phraseTable.append('<tr></tr>');
				var trOpts = phraseTable.find("tr").first().next().next().next();
				trOpts.append('<td colspan="4"></td>');
				var tdOpts = trOpts.find("td").first();
				if (($(window).width() < 512) || ($(window).height() < 512)) {
					tdOpts.append('<div class="checkboxitem"><input type="checkbox" class="searchPhraseOpts" name="CaseSensitive" id="searchPhrase_' + nSearchPhraseNextID + '_CaseSensitive" onclick="javascript:searchPhraseOptsChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');" /><label for="searchPhrase_' + nSearchPhraseNextID + '_CaseSensitive">Case</label></div>');
					tdOpts.append('<div class="checkboxitem"><input type="checkbox" class="searchPhraseOpts" name="AccentSensitive" id="searchPhrase_' + nSearchPhraseNextID + '_AccentSensitive" onclick="javascript:searchPhraseOptsChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');" /><label for="searchPhrase_' + nSearchPhraseNextID + '_AccentSensitive">Accent</label></div>');
				} else {
					tdOpts.append('<div class="checkboxitem"><input type="checkbox" class="searchPhraseOpts" name="CaseSensitive" id="searchPhrase_' + nSearchPhraseNextID + '_CaseSensitive" onclick="javascript:searchPhraseOptsChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');" /><label for="searchPhrase_' + nSearchPhraseNextID + '_CaseSensitive">Case Sensitive</label></div>');
					tdOpts.append('<div class="checkboxitem"><input type="checkbox" class="searchPhraseOpts" name="AccentSensitive" id="searchPhrase_' + nSearchPhraseNextID + '_AccentSensitive" onclick="javascript:searchPhraseOptsChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');" /><label for="searchPhrase_' + nSearchPhraseNextID + '_AccentSensitive">Accent Sensitive</label></div>');
				}
				tdOpts.append('<div class="checkboxitem"><input type="checkbox" class="searchPhraseOpts" name="Exclude" id="searchPhrase_' + nSearchPhraseNextID + '_Exclude" onclick="javascript:searchPhraseOptsChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');" /><label for="searchPhrase_' + nSearchPhraseNextID + '_Exclude">Exclude</label></div>');
				tdOpts.append('<div class="checkboxitem"><input type="checkbox" class="searchPhraseOpts" name="Disable" id="searchPhrase_' + nSearchPhraseNextID + '_Disable" onclick="javascript:searchPhraseOptsChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');" /><label for="searchPhrase_' + nSearchPhraseNextID + '_Disable">Disable</label></div>');
				phraseTable.append('<tr></tr>');
				var trBreak = phraseTable.find("tr").first().next().next().next().next();
				trBreak.append('<td colspan="4"></td>');
				var tdBreak = trBreak.find("td").first();
				tdBreak.append('<hr class="searchPhraseBreak" />');
				$("#searchPhrase_"+nSearchPhraseNextID+"_Text").autocomplete({
					delay: 500,
					maxShowItems: 5,
					minLength: 1,
					source: [ "" ],
					select: function(event, ui)
					{
						var input = document.getElementById(this.id);
						window.kjpbs.calcUpdatedPhrase($("#"+input.id).parents(".searchPhrase").attr("id"), input.value, ui.item.value, doGetCaretPosition(input));
						event.preventDefault();
						return false;
					},
					focus: function(event, ui)
					{
						event.preventDefault();
						return false;
					}
				});
				$("#searchPhrase_"+nSearchPhraseNextID+"_Text").data("LastCurPos", -1);
				$("#searchPhrase_"+nSearchPhraseNextID+"_Text").data("LastPhrase", "");
				$(document).ready(function() {
					$("#searchPhrase_"+nSearchPhraseNextID+"_Text").bind("keyup click paste focus", function() {
						var input = document.getElementById(this.id);
						var nCurPos = doGetCaretPosition(input);
						if ((nCurPos != $("#"+this.id).data("LastCurPos")) ||
							(input.value != $("#"+this.id).data("LastPhrase"))) {
							if (input.value) {
								window.kjpbs.autoCorrect($("#"+this.id).parents(".searchPhrase").attr("id"), input.value, nCurPos, $("#"+this.id).data("LastPhrase"), $("#"+this.id).data("LastCurPos"));
								$("#"+this.id).data("LastCurPos", nCurPos);
							}
							$("#"+this.id).data("LastPhrase", input.value);
							$("#"+this.id).autocomplete("close");
//							closeAllAutoCompleters();
						}
					});
				});
				$("#tabs").tabs("refresh");
				$("#searchPhrase_"+nSearchPhraseNextID+"_Text").focus();
				$("#searchPhrase_"+nSearchPhraseNextID+"_Text")[0].scrollIntoView();
				if (nSearchPhraseCount >= 5) {
					$( "#addSearchPhraseButton" ).button( "option", "disabled", true );
				}
			}
			$.ui.autocomplete.filter = function (array, term) {
				var matcher = new RegExp("^|\|" + $.ui.autocomplete.escapeRegex(term), "i");
				return $.grep(array, function (value) {
					return matcher.test(value.label || value.value || value);
				});
			};

			function searchPhraseChanged(aSearchPhrase) {
				var phrases = "";
				$(".searchPhraseText").each(function(i) {
					if (this.value) {
						if (phrases) {
							phrases = phrases + ";"
						}
						// order matters, see CPhraseEntry!
						if (document.getElementById($(this).parents(".searchPhrase").attr("id")+"_Disable").checked) {
							phrases = phrases + '\u00AC';
							document.getElementById($(this).parents(".searchPhrase").attr("id")+"_Occurrences").innerHTML = "N/A";
						}
						if (document.getElementById($(this).parents(".searchPhrase").attr("id")+"_Exclude").checked) {
							phrases = phrases + '\u2209';
						}
						if (document.getElementById($(this).parents(".searchPhrase").attr("id")+"_AccentSensitive").checked) {
							phrases = phrases + '\u00A4';
						}
						if (document.getElementById($(this).parents(".searchPhrase").attr("id")+"_CaseSensitive").checked) {
							phrases = phrases + '\u00A7';
						}
						phrases = phrases + this.value;
					}
				});
				if (aSearchPhrase) {
					var bDisable = document.getElementById(aSearchPhrase + "_Disable").checked;
					document.getElementById(aSearchPhrase + "_Text").disabled = bDisable;
					document.getElementById(aSearchPhrase + "_CaseSensitive").disabled = bDisable;
					document.getElementById(aSearchPhrase + "_AccentSensitive").disabled = bDisable;
					document.getElementById(aSearchPhrase + "_Exclude").disabled = bDisable;
					document.getElementById(aSearchPhrase + "_Besome").disabled = bDisable;
				}
				if (!phrases) {
					document.getElementById("searchResults").innerHTML = "";
					document.getElementById("searchResultsSummary").innerHTML = "";
					$("#tabs").tabs("option", "active", 0);
					$("#tabs").tabs("refresh");
//					scrollTabTop();
					return;
				}

				waitCursor(true);
				if (aSearchPhrase) {
					$("#"+aSearchPhrase+"_Text").autocomplete("close");
				} else {
					closeAllAutoCompleters();
				}
//				disableAllAutoCompleters();
				cleanPages();
				window.kjpbs.setSearchPhrases(phrases, getSearchWithin(), $('#searchScope').val());
			}

			function searchPhraseOptsChanged(aSearchPhrase) {
				searchPhraseChanged(aSearchPhrase);
			}

			function searchPhraseTextChanged(aSearchPhrase) {
				var input = document.getElementById(aSearchPhrase+"_Text");
				var theAC = document.getElementById(aSearchPhrase+"_AC");
				var theOccurrences = document.getElementById(aSearchPhrase+"_Occurrences");
				if (!input.value) {
					theAC.innerHTML = "&nbsp;";
					theOccurrences.innerHTML = "N/A";
				} else {
					if (input.value != $("#"+aSearchPhrase+"_Text").data("LastPhrase")) {
						theOccurrences.innerHTML = "???";
					}
				}
			}

			function searchPhraseBesome(aSearchPhrase) {
				var input = document.getElementById(aSearchPhrase+"_Text");
				input.value = "";
				searchPhraseTextChanged(aSearchPhrase);
				searchPhraseChanged(aSearchPhrase);
				input.focus();
			}

			function searchPhraseClose(aSearchPhrase) {
				if (nSearchPhraseCount <= 1) {
					// If there's only 1 search phrase left, treat it as a clear instead,
					//		however, re-enable it if it was disabled and reset other flags
					//		to treat it like a destroy and re-create:
					document.getElementById(aSearchPhrase + "_Disable").checked = false;
					document.getElementById(aSearchPhrase + "_Exclude").checked = false;
					document.getElementById(aSearchPhrase + "_AccentSensitive").checked = false;
					document.getElementById(aSearchPhrase + "_CaseSensitive").checked = false;
					searchPhraseBesome(aSearchPhrase);
				} else {
					var nextPhrase = $("#"+aSearchPhrase).next();
					if (!nextPhrase.length) {
						nextPhrase = $("#"+aSearchPhrase).prev();
					}
					$("#"+aSearchPhrase).remove();
					nSearchPhraseCount = nSearchPhraseCount - 1;
					searchPhraseChanged();
					$("#"+nextPhrase.attr("id")+"_Text").focus();

					if (nSearchPhraseCount < 5) {
						$( "#addSearchPhraseButton" ).button( "option", "disabled", false );
					}
				}
			}

			function gotoIndex(ndx, nMoveMode, strParam)
			{
				waitCursor(true);
				window.kjpbs.gotoIndex(ndx, nMoveMode, strParam);
			}

			function gotoResult(nChp, ndxRel)
			{
				if (havePage(nChp)) {
					turnToPage(nChp);
					highlightAnchor(ndxRel);
				} else {
					gotoIndex(ndxRel, 0, "highlightAnchor");
				}
			}

			function gotoChapter(nChp, strParam)
			{
				if (window.kjpbs) {
					window.kjpbs.gotoChapter(nChp, strParam);
				}
			}

			function highlightAnchor(ndxRel)
			{
				var anchorElement = $("#" + ndxRel);
				if (anchorElement) {
					anchorElement.addClass("selected");
					anchorElement.next().addClass("selected");
				}
			}

			function checkKey(e) {

				e = e || window.event;

				if (e.altKey) {
					switch (e.keyCode) {
						case 37:		// Left arrow
							closeAllAutoCompleters();
							$("#tabs").tabs("option", "active",
									(($("#tabs").tabs("option", "active") == 0) ?
											$("#tabs").tabs("option", "active", 1) :
											$("#tabs").tabs("option", "active", $("#tabs").tabs("option", "active")-1)));
							break;
						case 39:		// Right arrow
							closeAllAutoCompleters();
							$("#tabs").tabs("option", "active",
									(($("#tabs").tabs("option", "active") == 1) ?
											$("#tabs").tabs("option", "active", 0) :
											$("#tabs").tabs("option", "active", $("#tabs").tabs("option", "active")+1)));
							break;
						// Note: up=38, down=40
						default:
							return;
					}
					e.preventDefault();
				} else {
					switch (e.keyCode) {
						case 13:		// Enter
							closeAllAutoCompleters();
							// If a input box is active, force searchPhraseChanged:
							if (document.activeElement) {
								if ($("#"+document.activeElement.id).hasClass("searchPhraseText")) {
									$("#"+document.activeElement.id).autocomplete("close");
									searchPhraseTextChanged($("#"+document.activeElement.id).parents(".searchPhrase").attr("id"));
									searchPhraseChanged();
									break;
								}
							}
							return;
					}
				}
			}
			document.onkeydown = checkKey;

			function havePage(page) {
				return false;
			}

			// Adds the pages that the "Scripture Book" will need
			function addPage(page, strText) {
				if (!havePage(page)) {
					// TODO : Add page
					document.getElementById("scriptureText").innerHTML = strText;
				} else {
					document.getElementById("scriptureText").innerHTML = strText;
				}
			}

			// Clear pages removes the "Scripture Book" content for existing
			//		pages so they can be refetched (such as search changed
			//		where the highlighting/markup has changed)
			function cleanPages() {
				// TODO : Clear page cache
			}

			function turnToPage(page) {
				// TODO : Switch to page

				nBrowserChapterCurrent = page;
			}

			function navPrevChapter() {
				if (nBrowserChapterCurrent > 1) {
					gotoChapter(nBrowserChapterCurrent-1, "scrollTabTop");
				}
				document.getElementById("prevChpButton").blur();	// Workaround jqueryui bug
				$("#prevChpButton").removeClass('ui-state-focus ui-state-hover ui-state-active');
			}

			function navNextChapter() {
				if (nBrowserChapterCurrent < bkChpStruct.chapterCount) {
					gotoChapter(nBrowserChapterCurrent+1, "scrollTabTop");
				}
				document.getElementById("nextChpButton").blur();	// Workaround jqueryui bug
				$("#nextChpButton").removeClass('ui-state-focus ui-state-hover ui-state-active');
			}

			function navLocate() {
				// TODO : Create navigate dialog
				document.getElementById("locateButton").blur();	// Workaround jqueryui bug
				$("#locateButton").removeClass('ui-state-focus ui-state-hover ui-state-active');
			}

		</script>
		<style type="text/css">
			html {
				height: 100%;
				width: 100%;
			}

			.checkboxitem {
				white-space: nowrap;
				display:inline
			}

			table.searchPhraseTable
			{
				margin-left: auto;
				margin-right: auto;
				border-collapse: collapse;
				border-spacing: 0;
			}

			table.searchSpec
			{
				margin-left: auto;
				margin-right: auto;
				border-collapse: collapse;
				border-spacing: 0;
			}

			td.searchPhraseTable {
				text-align: left;
				vertical-align: center;
				padding:0; margin:0;
			}

			td.shrink {
				width: 1%;
				white-space: nowrap;
			}

			td.expand {
				width: 99%;
			}

			img {
				max-width: 100%;
			}

			input, textarea {
				max-width: 100%;
			}

			.ui-tabs .ui-tabs-panel {
				padding: 0;
			}

			.ui-accordion .ui-accordion-content {
				padding: 0;
			}

			span.fancytree-title {
				white-space: normal;
				max-width: 100%;
				padding: 0;
			}

			.book { font-size:xx-large; font-weight:bold; }
			.chapter { font-size:x-large; font-weight:bold; }
			.subtitle { font-size:medium; font-weight:normal; font-style:italic; }
			.category { font-size:medium; font-weight:normal; }
			.superscription { font-size:medium; font-weight:normal; font-style:italic; }
			.colophon { font-size:medium; font-weight:normal; font-style:italic; }

			.selected { background:LightGoldenRodYellow; }

			.searchPhrase {
				max-width: 100%;
			}

			.searchPhraseOccurrences {
				white-space: nowrap;
				display:inline
			}

			.searchPhraseAC {
				margin: 0 5px 0 0;
				width: 100%;
				max-width: 100%;
			}
			.searchPhraseText {
				margin: 0 5px 5px 0;
				width: 100%;
				max-width: 100%;
			}
			.searchPhraseBesome {
				width: 24px;
				height: 24px;
				margin: 0 auto;

			}
			.searchPhraseClose {
				width: 24px;
				height: 24px;
				margin: 0 auto;
			}
			.searchPhraseBreak {
				max-width: 100%;
				margin: 0px;
			}

			#addSearchPhraseButton {
				margin:0px;
			}

			#output {
				width: 500px;
				height: 75px;
			}
			#searchSpec {
				width: 100%;
				margin: 0 auto;
			}
			#searchScope {
				width: 100%;
				max-width: 100%;
				padding: 0;
				margin: 0 auto;
			}
			#searchResultsSummary {
				text-align: center;
				width: 100%;
				margin: 0 auto;
			}
			#searchResults {
				list-style-type: none;
				width: 100%;
				min-height: 300px;
				max-height: auto;
				margin-left: auto;
				margin-right: auto;
			}
			.scriptureText {
				width: 100%;
				min-height: 300px;
				max-height: auto;
				margin: 0 auto;
				margin-bottom: 30px;
			}

			#scriptureNav_buttonset {
				text-align: center;
			}

			#scriptureNav .scriptureNav_box {
				position: fixed;
				text-align: center;
				overflow: hidden;
				z-index: -1;
				opacity: 0;
				width: 100%;
				height: auto;
				left: 0px;
				bottom: 0px;
				background: rgba(0,0,0,0.4);
				-webkit-transition: all 0.3s ease-in-out;
				-moz-transition: all 0.3s ease-in-out;
				-o-transition: all 0.3s ease-in-out;
				transition: all 0.3s ease-in-out;
			}
			#toggle-nav { display: none; }

			#toggle-nav:checked ~ .scriptureNav_box {
				opacity: 1;
				z-index: 400;
			}
			#toggle-nav:checked ~ .scriptureNav_box div {
				-webkit-transform: scale(1);
				-moz-transform: scale(1);
				-ms-transform: scale(1);
				transform: scale(1);
			}
		</style>
	</head>
	<body>
		<div id="mainbody">
			<div id="status">
				<h1>King James Pure Bible Search</h1>
				<h2>WebChannel Server</h2>
				<textarea id="output"></textarea><br />
			</div>

			<div id="tabs">
				<ul>
					<li><a href="#search"><span>Search</span></a></li>
					<li><a href="#browser"><span>Scripture Browser</span></a></li>
				</ul>

				<div id="search">
					<table class="searchSpec" id="searchSpec">
						<tr>
							<td class="expand">
								<div id="searchCriteria">
									<div id="searchWithin">
										<h3>Search Within</h3>
										<div id="searchWithinTree"></div>
									</div>
									<label style="display: block;" for="searchScope">Search Scope:</label>
									<select class="searchScope" name="searchScope" id="searchScope" title="Select Search Scope">
										<option value="-1">Anywhere in Selected Text</option>
										<option value="0">Together in Selected Text</option>
										<option value="1">Same Testament</option>
										<option value="5">Same Category</option>
										<option value="2">Same Book</option>
										<option value="3">Same Chapter</option>
										<option value="4">Same Verse</option>
									</select>
								</div>
							</td>
						</tr>
						<tr>
							<td>
								<hr />
							</td>
						</tr>
						<tr>
							<td class="expand">
								<div id="phrases"></div>
							</td>
						</tr>
						<tr>
							<td class="expand" style="text-align:center">
								<div id="searchControls">
									<button type="button" id="addSearchPhraseButton" onclick="javascript:addSearchPhrase();">Add Search Phrase</button>
								</div>
							</td>
						</tr>
						<tr>
							<td class="expand">
								<div id="searchResultsSummary"></div>
							</td>
						</tr>
						<tr>
							<td>
								<hr />
							</td>
						</tr>
						<tr>
							<td class="expand">
								<div id="searchResults"></div>
							</td>
						</tr>
					</table>
				</div>

				<div id="browser">
					<div id="scriptureBook">
						<div id="scriptureText" class="scriptureText"></div>
					</div>
				</div>
			</div>
			<nav id="scriptureNav">
				<input type="checkbox" id="toggle-nav" />
				<div class="scriptureNav_box">
					<div id="scriptureNav_buttonset">
						<button type="button" id="prevChpButton" onclick="javascript:navPrevChapter();">Prev</button>
						<button type="button" id="locateButton" onclick="javascript:navLocate();">Locate</button>
						<button type="button" id="nextChpButton" onclick="javascript:navNextChapter();">Next</button>
					</div>
				</div>
			</nav>
		</div>

		<script>
			var initJsonSearchWithinTree = [ ];

			$(document).tooltip();
			$( "#tabs" ).tabs({
				activate: function( event, ui ) {
					if ($(this).tabs("option", "active") == 0) {
						document.getElementById("toggle-nav").checked = false;
					} else {
						document.getElementById("toggle-nav").checked = true;
					}
				}
			});
			$( "#addSearchPhraseButton" ).button();
			$( "#searchWithin" ).accordion({
				collapsible: true,
				animate: 200,
				active: false,
				heightStyle: "content"
			});
			$( "#searchScope" ).selectmenu({
				width : '100%',
				select: function(event, ui) { searchPhraseChanged(); }
			}).selectmenu("menuWidget").addClass("overflow");
			$( "#searchScope" ).selectmenu().data("ui-selectmenu")._renderItem =
			function( ul, item ) {
				var li = $( "<li>" )
						.css( "background-color", item.value );

				if ( item.disabled ) {
					li.addClass( "ui-state-disabled" );
				}

				this._setText( li, item.label );

				if (item.value == -1)
					li.attr("title", "Anywhere is an Unscoped Search finding the search phrases indepdendent of one another within the selected text");
				if (item.value == 0)
					li.attr("title", "Together is a Scoped Search requiring that all search phrases be found within the selected text");
				if (item.value == 1)
					li.attr("title", "Same Testament is a Scoped Search requiring that all search phrases be found together in the same Testament within the selected text");
				if (item.value == 5)
					li.attr("title", "Same Category is a Scoped Search requiring that all search phrases be found together in the same Category within the selected text");
				if (item.value == 2)
					li.attr("title", "Same Book is a Scoped Search requiring that all search phrases be found together in the same Book within the selected text");
				if (item.value == 3)
					li.attr("title", "Same Chapter is a Scoped Search requiring that all search phrases be found together in the same Chapter within the selected text");
				if (item.value == 4)
					li.attr("title", "Same Verse is a Scoped Search requiring that all search phrases be found together in the same Verse within the selected text");

				return li.appendTo( ul );
			}

			$( "#searchWithinTree" ).fancytree({
				extensions: ["themeroller"],
				checkbox: true,
				selectMode: 3,
				icons: false,
				tabbable: true,
				titlesTabbable: true,
				autoScroll: true,
				activeVisible: true,
				minExpandLevel: 2,
				source: initJsonSearchWithinTree,
//				source: { url: "testit.json", cache: false },
//				loadChildren: function(event, ctx) {
//					ctx.node.fixSelection3AfterClick();
//					ctx.node.fixSelection3FromEndNodes();
//				},
				select: function(event, data) {
					searchPhraseChanged();
				},
				dblclick: function(event, data) {
					data.node.toggleSelected();
				},
				keydown: function(event, data) {
					if( event.which === 32 ) {
						data.node.toggleSelected();
						return false;
					}
				},
				// The following options are only required, if we have more than one tree on one page:
				//        initId: "treeData",
				cookieId: "fancytree-searchWithinTree",
				idPrefix: "fancytree-searchWithinTree-"
			});

			$( "#scriptureNav_buttonset" ).buttonset();

			addSearchPhrase();			// Add initial search phrase
//			var markup = document.getElementsByTagName('body')[0].innerHTML;
//			alert(markup);
		</script>


	</body>
</html>
