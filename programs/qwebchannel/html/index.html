<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>King James Pure Bible Search Standalone Server</title>
		<link rel="stylesheet" href="jquery/jquery-ui/1.11.4/themes/start/jquery-ui.css">
		<script src="jquery/jquery-1.11.3.js"></script>
		<script src="jquery/jquery-ui/1.11.4/jquery-ui.js"></script>
		<script src="jquery/jquery-ui/jquery-ui-autocomplete-scroll/0.1.7/jquery.ui.autocomplete.scroll.js"></script>
		<script type="text/javascript" src="./qwebchannel.js"></script>
		<script type="text/javascript">
			var bEnableScriptureBrowserTabSwap = false;
			var nSearchPhraseCount = 0;
			var nSearchPhraseNextID = 0;

			//BEGIN SETUP
			function output(message)
			{
				var output = document.getElementById("output");
				output.innerHTML = output.innerHTML + message + "\n";
			}
			function hideKeyboard() {
				//this set timeout needed for case when hideKeyborad
				//is called inside of 'onfocus' event handler
				setTimeout(function() {
					//creating temp field
					var field = document.createElement('input');
					field.setAttribute('type', 'text');
					//hiding temp field from peoples eyes
					//-webkit-user-modify is nessesary for Android 4.x
					field.setAttribute('style', 'position:absolute; top: 0px; opacity: 0; -webkit-user-modify: read-write-plaintext-only; left:0px;');
					document.body.appendChild(field);

					//adding onfocus event handler for out temp field
					field.onfocus = function(){
						//this timeout of 200ms is nessasary for Android 2.3.x
						setTimeout(function() {

							field.setAttribute('style', 'display:none;');
							setTimeout(function() {
								document.body.removeChild(field);
								document.body.focus();
							}, 14);
						}, 200);
					};

					//focusing it
					field.focus();
				}, 50);
			}
			function makeRelIndex(book, chapter, verse, word)
			{
				return ((book & 0xFF) << 24) |
						((chapter & 0xFF) << 16) |
						((verse & 0xFF) << 8) |
						(word & 0xFF);
			}
			function relIndexBook(ndxRel)
			{
				return ((ndxRel >> 24) & 0xFF);
			}
			function relIndexChapter(ndxRel)
			{
				return ((ndxRel >> 16) & 0xFF);
			}
			function relIndexVerse(ndxRel)
			{
				return ((ndxRel >> 8) & 0xFF);
			}
			function relIndexWord(ndxRel)
			{
				return (ndxRel & 0xFF);
			}
			function scrollTabTop()
			{
				$("html, #tabs").animate({
					scrollTop: 0
				}, 200);
			}
			function doGetCaretPosition(oField) {
				var iCaretPos = 0;

				// IE Support
				if (document.selection) {
					// Set focus on the element
					oField.focus();

					// To get cursor position, get empty selection range
					var oSel = document.selection.createRange();

					// Move selection start to 0 position
					oSel.moveStart('character', -oField.value.length);

					// The caret position is selection length
					iCaretPos = oSel.text.length;
				}
				// Firefox support
				else if (oField.selectionStart || oField.selectionStart == '0') {
					iCaretPos = ((oField.selectionDirection=='backward') ? oField.selectionStart : oField.selectionEnd);
				}
				// Else fallback to field length
				else {
					iCaretPos = oField.value.length;
				}

				return (iCaretPos);
			}
			function scrollToAnchor(anAnchor)
			{
				var element_to_scroll_to = document.getElementById(anAnchor);
				element_to_scroll_to.scrollIntoView();
			}
			function closeAllAutoCompleters()
			{
				$(".searchPhraseText").each(function(i) {
					$("#"+this.id).autocomplete("close");
				});
			}
			function enableAllAutoCompleters()
			{
				$(".searchPhraseText").each(function(i) {
					$("#"+this.id).autocomplete("enable");
				});
			}
			function disableAllAutoCompleters()
			{
				$(".searchPhraseText").each(function(i) {
					$("#"+this.id).autocomplete("disable");
				});
			}
			window.onload = function() {
				var baseUrl = (/[?&]webChannelBaseUrl=([A-Za-z0-9\-:/\.]+)/.exec(location.search)[1]);
				output("Connecting to WebSocket server at " + baseUrl + ".");
				var socket = new WebSocket(baseUrl);

				socket.onclose = function()
				{
					output("WebChannel Connection Closed");
					alert("WebChannel Connection Closed");
				};
				socket.onerror = function(error)
				{
					output("WebChannel Error: " + error);
					alert("WebChannel Error: " + error);
				};
				socket.onopen = function()
				{
					output("WebSocket connected, setting up QWebChannel.");
					new QWebChannel(socket, function(channel) {
						// make our kjpbs object accessible globally
						window.kjpbs = channel.objects.kjpbs;

						kjpbs.searchResultsChanged.connect(function(strHtmlLiSearchResults) {
							document.getElementById("searchResults").innerHTML = strHtmlLiSearchResults;
							$("#tabs").tabs("option", "active", 0);
							$("#tabs").tabs("refresh");
							scrollTabTop();
							// Wait cursor back off
							$("body").css("cursor", "default");
//							enableAllAutoCompleters();
							closeAllAutoCompleters();
						});

						kjpbs.scriptureBrowserRender.connect(function(ndxRel, strHtmlScripture) {
							document.getElementById("scriptureText").innerHTML = strHtmlScripture;
							if (bEnableScriptureBrowserTabSwap) {
								$("#tabs").tabs("option", "active", 1);
								$("#tabs").tabs("refresh");
								scrollToAnchor(ndxRel);
							}
							// Select the text from the navigation:
							$("#" + ndxRel).addClass("selected");
							$("#" + ndxRel).next().addClass("selected");
							// Wait cursor back off
							$("body").css("cursor", "default");
						});

						kjpbs.setAutoCorrectText.connect(function(strElementID, strAC) {
							document.getElementById(strElementID+"_AC").innerHTML = "&nbsp;" + strAC;
						});

						kjpbs.setAutoCompleter.connect(function(strElementID, strlstCompleter) {
							$("#"+strElementID+"_Text").autocomplete("option", "source", strlstCompleter.split(";"));
						});

						kjpbs.updatePhrase.connect(function(strElementID, strNewPhrase) {
							document.getElementById(strElementID+"_Text").value = strNewPhrase;
							searchPhraseChanged(strElementID);
						});

						bEnableScriptureBrowserTabSwap = false;
						$("#tabs").tabs("option", "active", 1);
						$("#tabs").tabs("refresh");
						hideKeyboard();
						kjpbs.gotoIndex(makeRelIndex(1, 1, 0, 0));
						scrollTabTop();

						output("Connected to WebChannel, ready to send/receive searches!");
					});
				}
			}
			//END SETUP

			function addSearchPhrase() {
				nSearchPhraseCount = nSearchPhraseCount + 1;
				nSearchPhraseNextID = nSearchPhraseNextID + 1;
				$("#phrases").append('<div class="searchPhrase" id="searchPhrase_' + nSearchPhraseNextID + '"></div>');
				var newPhrase = $("#searchPhrase_" + nSearchPhraseNextID);
				newPhrase.append('<table class="searchPhraseTable" id="searchPhrase_' + nSearchPhraseNextID + '_Table"></table>');
				var phraseTable = $("#searchPhrase_" + nSearchPhraseNextID + "_Table");
				phraseTable.append('<tr></tr>');
				var trAC = phraseTable.find("tr").first();
				trAC.append('<td class="expand"></td>');
				trAC.append('<td>&nbsp;</td>');
				trAC.append('<td></td>');
				trAC.append('<td></td>');
				var tdAC = trAC.find("td").first();
				tdAC.append('<p class="searchPhraseAC" id="searchPhrase_' + nSearchPhraseNextID + '_AC">&nbsp;</p>');
				phraseTable.append('<tr></tr>');
				var trInput = phraseTable.find("tr").first().next();
				trInput.append('<td class="expand"></td>');
				trInput.append('<td>&nbsp;</td>');
				trInput.append('<td></td>');
				trInput.append('<td></td>');
				var tdInput = trInput.find("td").first();
				tdInput.append('<input class="searchPhraseText" id="searchPhrase_' + nSearchPhraseNextID + '_Text" type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" onchange="javascript:searchPhraseChanged(\'searchPhrase_' + nSearchPhraseNextID + '\');" />')
							.on('change keyup paste input', function() { searchPhraseTextChanged($(this).parents(".searchPhrase").attr("id")); });
				var tdBesome = trInput.find("td").first().next().next();
				tdBesome.append('<input type="image" value="Clear" class="searchPhraseBesome" id="searchPhrase_' + nSearchPhraseNextID + '_Besome" src="edit_clear.png" onclick="javascript:searchPhraseBesome(\'searchPhrase_' + nSearchPhraseNextID + '\');" />');
				var tdClose = trInput.find("td").first().next().next().next();
				tdClose.append('<input type="image" value="Close" class="searchPhraseClose" id="searchPhrase_' + nSearchPhraseNextID + '_Close" src="Close.png" onclick="javascript:searchPhraseClose(\'searchPhrase_' + nSearchPhraseNextID + '\');" />');
				phraseTable.append('<tr></tr>');
				var trBreak = phraseTable.find("tr").first().next().next();
				trBreak.append('<td colspan="4"></td>');
				var tdBreak = trBreak.find("td").first();
				tdBreak.append('<hr class="searchPhraseBreak" />');
				$("#searchPhrase_"+nSearchPhraseNextID+"_Text").autocomplete({
					delay: 500,
					maxShowItems: 5,
					minLength: 1,
					source: [ "" ],
					select: function(event, ui)
					{
						var input = document.getElementById(this.id);
						window.kjpbs.calcUpdatedPhrase($("#"+input.id).parents(".searchPhrase").attr("id"), input.value, ui.item.value, doGetCaretPosition(input));
						event.preventDefault();
						return false;
					},
					focus: function(event, ui)
					{
						event.preventDefault();
						return false;
					}
				});
				$("#searchPhrase_"+nSearchPhraseNextID+"_Text").data("LastCurPos", 0);
				$(document).ready(function() {
					$("#searchPhrase_"+nSearchPhraseNextID+"_Text").bind("keyup click paste focus", function() {
						var input = document.getElementById(this.id);
						var nCurPos = doGetCaretPosition(input);
						if (nCurPos != $("#"+this.id).data("LastCurPos")) {
							$("#"+this.id).data("LastCurPos", nCurPos);
							if (input.value) {
								window.kjpbs.autoCorrect($("#"+this.id).parents(".searchPhrase").attr("id"), input.value, nCurPos);
							}
							$("#"+this.id).autocomplete("close");
//							closeAllAutoCompleters();
						}
					});
				});
				$("#tabs").tabs("refresh");
				$("#searchPhrase_"+nSearchPhraseNextID+"_Text").focus();
			}
			$.ui.autocomplete.filter = function (array, term) {
				var matcher = new RegExp("^|\|" + $.ui.autocomplete.escapeRegex(term), "i");
				return $.grep(array, function (value) {
					return matcher.test(value.label || value.value || value);
				});
			};

			function searchPhraseChanged(aSearchPhrase) {
				var phrases = "";
				$(".searchPhraseText").each(function(i) {
					if (phrases) {
						phrases = phrases + ";"
					}
					phrases = phrases + this.value;
				});
				if (!phrases) {
					document.getElementById("searchResults").innerHTML = "";
					$("#tabs").tabs("option", "active", 0);
					$("#tabs").tabs("refresh");
					scrollTabTop();
					return;
				}

				$("body").css("cursor", "progress");
				$("#"+aSearchPhrase+"_Text").autocomplete("close");
//				disableAllAutoCompleters();
				window.kjpbs.setSearchPhrases(phrases);
			}

			function searchPhraseTextChanged(aSearchPhrase) {
				var input = document.getElementById(aSearchPhrase+"_Text");
				var thePhrase = document.getElementById(aSearchPhrase+"_AC");
				var text = input.value;
				if (!text) {
					thePhrase.innerHTML = "&nbsp;";
				} else {
					window.kjpbs.autoCorrect(aSearchPhrase, text, doGetCaretPosition(input));
				}
			}

			function searchPhraseBesome(aSearchPhrase) {
				var input = document.getElementById(aSearchPhrase+"_Text");
				input.value = "";
				searchPhraseTextChanged(aSearchPhrase);
				searchPhraseChanged(aSearchPhrase);
				input.focus();
			}

			function searchPhraseClose(aSearchPhrase) {
				if (nSearchPhraseCount <= 1) {
					// If there's only 1 search phrase left, treat it as a clear instead:
					searchPhraseBesome(aSearchPhrase);
				} else {
					var nextPhrase = $("#"+aSearchPhrase).next();
					if (!nextPhrase.length) {
						nextPhrase = $("#"+aSearchPhrase).prev();
					}
					$("#"+aSearchPhrase).remove();
					nSearchPhraseCount = nSearchPhraseCount - 1;
					searchPhraseChanged();
					$("#"+nextPhrase.attr("id")+"_Text").focus();
				}
			}

			function gotoIndex(ndx)
			{
				bEnableScriptureBrowserTabSwap = true;
				$("body").css("cursor", "progress");
				window.kjpbs.gotoIndex(ndx);
			}

			function checkKey(e) {

				e = e || window.event;

				if (e.altKey) {
					switch (e.keyCode) {
						case 13:		// Enter
							closeAllAutoCompleters();
							// If a input box is active, force searchPhraseChanged:
							if (window.activeElement) {
								if ($("#"+window.activeElement.id).hasClass("searchPhraseText")) {
									$("#"+window.activeElement.id).autocomplete("close");
									searchPhraseTextChanged($("#"+window.activeElement.id).parents(".searchPhrase").attr("id"));
									searchPhraseChanged();
									break;
								}
							}
							return;
						case 37:		// Left arrow
							closeAllAutoCompleters();
							$("#tabs").tabs("option", "active",
									(($("#tabs").tabs("option", "active") == 0) ?
											$("#tabs").tabs("option", "active", 1) :
											$("#tabs").tabs("option", "active", $("#tabs").tabs("option", "active")-1)));
							break;
						case 39:		// Right arrow
							closeAllAutoCompleters();
							$("#tabs").tabs("option", "active",
									(($("#tabs").tabs("option", "active") == 1) ?
											$("#tabs").tabs("option", "active", 0) :
											$("#tabs").tabs("option", "active", $("#tabs").tabs("option", "active")+1)));
							break;
						// Note: up=38, down=40
						default:
							return;
					}
					e.preventDefault();
				}
			}
			document.onkeydown = checkKey;
		</script>
		<style type="text/css">
			html {
				height: 100%;
				width: 100%;
			}

			table.searchPhraseTable
			{
				margin-left: auto;
				margin-right: auto;
			}

			td.searchPhraseTable {
				text-align: left;
				vertical-align: center;
			}

			td.shrink {
				width: 1%;
				white-space: nowrap;
			}

			td.expand {
				width: 99%;
			}

			img {
				max-width: 100%;
			}

			input, textarea {
				max-width: 100%;
			}

			.book { font-size:xx-large; font-weight:bold; }
			.chapter { font-size:x-large; font-weight:bold; }
			.subtitle { font-size:medium; font-weight:normal; font-style:italic; }
			.category { font-size:medium; font-weight:normal; }
			.superscription { font-size:medium; font-weight:normal; font-style:italic; }
			.colophon { font-size:medium; font-weight:normal; font-style:italic; }

			.selected { background:LightGoldenRodYellow; }

			.searchPhrase {
				max-width: 100%;
			}

			.searchPhraseAC {
				margin: 0 5px 0 0;
				width: 100%;
				max-width: 100%;
			}
			.searchPhraseText {
				margin: 0 5px 5px 0;
				width: 100%;
				max-width: 100%;
			}
			.searchPhraseBesome {
				width: 24px;
				height: 24px;
				margin: 0 auto;

			}
			.searchPhraseClose {
				width: 24px;
				height: 24px;
				margin: 0 auto;
			}
			.searchPhraseBreak {
				max-width: 100%;
				margin: 0px;
			}

			#addSearchPhraseButton {
				margin:0px;
			}

			#output {
				width: 500px;
				height: 75px;
			}
			#searchSpec {
			}
			#searchResults {
				list-style-type: none;
				width: 100%;
				min-height: 300px;
				max-height: auto;
				margin-left: auto;
				margin-right: auto;
			}
			#scriptureText {
				width: 100%;
				min-height: 300px;
				max-height: auto;
				margin: 0 auto;
			}
		</style>
	</head>
	<body>
		<div id="status">
			<h1>King James Pure Bible Search</h1>
			<h2>WebChannel Server</h2>
			<textarea id="output"></textarea><br />
		</div>

		<div id="tabs">
			<ul>
				<li><a href="#search"><span>Search</span></a></li>
				<li><a href="#browser"><span>Scripture Browser</span></a></li>
			</ul>

			<div id="search">
				<table id="searchSpec">
					<tr>
						<td class="expand" colspan="2">
							<div id="searchCriteria"></div>
						</td>
						<td class="shrink">
							&nbsp;
						</td>
					</tr>
					<tr>
						<td class="shrink">&nbsp;</td>
						<td class="expand">
							<div id="phrases"></div>
						</td>
						<td class="shrink">
							&nbsp;
						</td>
					</tr>
					<tr>
						<td class="shrink">&nbsp;</td>
						<td class="expand" style="text-align:center">
							<div id="searchControls">
								<button type="button" id="addSearchPhraseButton" onclick="javascript:addSearchPhrase();">Add Search Phrase</button>
							</div>
						</td>
						<td class="shrink">
							&nbsp;
						</td>
					</tr>
					<tr>
						<td colspan="3">
							<hr />
						</td>
					</tr>
					<tr>
						<td class="expand" colspan="3">
							<div id="searchResultsSummary"></div>
						</td>
					</tr>
					<tr>
						<td class="expand" colspan="3">
							<div id="searchResults"></div>
						</td>
					</tr>
				</table>
			</div>

			<div id="browser">
				<div id="scriptureText">
				</div>
			</div>
		</div>

		<script>
			$( "#tabs" ).tabs();
			$( "#addSearchPhraseButton" ).button();
			addSearchPhrase();			// Add initial search phrase
//			var markup = document.getElementsByTagName('body')[0].innerHTML;
//			alert(markup);
		</script>


	</body>
</html>
