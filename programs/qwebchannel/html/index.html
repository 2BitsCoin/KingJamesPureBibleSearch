<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>King James Pure Bible Search Standalone Server</title>
		<link rel="stylesheet" href="jquery/jquery-ui/1.11.4/themes/start/jquery-ui.css">
		<script src="jquery/jquery-1.11.3.js"></script>
		<script src="jquery/jquery-ui/1.11.4/jquery-ui.js"></script>
		<script type="text/javascript" src="./qwebchannel.js"></script>
		<script type="text/javascript">
			var bEnableScriptureBrowserTabSwap = false;

			//BEGIN SETUP
			function output(message)
			{
				var output = document.getElementById("output");
				output.innerHTML = output.innerHTML + message + "\n";
			}
			function makeRelIndex(book, chapter, verse, word)
			{
				return ((book & 0xFF) << 24) |
						((chapter & 0xFF) << 16) |
						((verse & 0xFF) << 8) |
						(word & 0xFF);
			}
			function relIndexBook(ndxRel)
			{
				return ((ndxRel >> 24) & 0xFF);
			}
			function relIndexChapter(ndxRel)
			{
				return ((ndxRel >> 16) & 0xFF);
			}
			function relIndexVerse(ndxRel)
			{
				return ((ndxRel >> 8) & 0xFF);
			}
			function relIndexWord(ndxRel)
			{
				return (ndxRel & 0xFF);
			}
			function scrollTabTop()
			{
				$("html, #tabs").animate({
					scrollTop: 0
				}, 200);
			}
			function scrollToAnchor(anAnchor)
			{
				var element_to_scroll_to = document.getElementById(anAnchor);
				element_to_scroll_to.scrollIntoView();
			}
			window.onload = function() {
				var baseUrl = (/[?&]webChannelBaseUrl=([A-Za-z0-9\-:/\.]+)/.exec(location.search)[1]);
				output("Connecting to WebSocket server at " + baseUrl + ".");
				var socket = new WebSocket(baseUrl);

				socket.onclose = function()
				{
					output("WebChannel Connection Closed");
					alert("WebChannel Connection Closed");
				};
				socket.onerror = function(error)
				{
					output("WebChannel Error: " + error);
					alert("WebChannel Error: " + error);
				};
				socket.onopen = function()
				{
					output("WebSocket connected, setting up QWebChannel.");
					new QWebChannel(socket, function(channel) {
						// make our kjpbs object accessible globally
						window.kjpbs = channel.objects.kjpbs;

						document.getElementById("searchPhrase").searchPhraseChanged = function() {
							var input = document.getElementById("searchPhrase");
							var text = input.value;
							if (!text) {
								document.getElementById("searchResults").innerHTML = "";
								$("#tabs").tabs("option", "active", 0);
								$("#tabs").tabs("refresh");
								scrollTabTop();
								return;
							}

							$("body").css("cursor", "progress");
							kjpbs.setSearchPhrases(text);
						}

						kjpbs.searchResultsChanged.connect(function(strHtmlLiSearchResults) {
							document.getElementById("searchResults").innerHTML = strHtmlLiSearchResults;
							$("#tabs").tabs("option", "active", 0);
							$("#tabs").tabs("refresh");
							scrollTabTop();
							// Wait cursor back off
							$("body").css("cursor", "default");
						});

						kjpbs.scriptureBrowserRender.connect(function(ndxRel, strHtmlScripture) {
							document.getElementById("scriptureText").innerHTML = strHtmlScripture;
							if (bEnableScriptureBrowserTabSwap) {
								$("#tabs").tabs("option", "active", 1);
								$("#tabs").tabs("refresh");
								scrollToAnchor(ndxRel);
							}
							// Select the text from the navigation:
							$("#" + ndxRel).addClass("selected");
							$("#" + ndxRel).next().addClass("selected");
							// Wait cursor back off
							$("body").css("cursor", "default");
						});

						bEnableScriptureBrowserTabSwap = false;
						kjpbs.gotoIndex(makeRelIndex(1, 1, 0, 0));
						$("#tabs").tabs("option", "active", 1);
						$("#tabs").tabs("refresh");
						scrollTabTop();

						output("Connected to WebChannel, ready to send/receive searches!");
					});
				}
			}
			//END SETUP

			function gotoIndex(ndx)
			{
				bEnableScriptureBrowserTabSwap = true;
				$("body").css("cursor", "progress");
				window.kjpbs.gotoIndex(ndx);
			}

			function checkKey(e) {

				e = e || window.event;

				if (e.altKey) {
					switch (e.keyCode) {
						case 37:		// Left arrow
							$("#tabs").tabs("option", "active",
									(($("#tabs").tabs("option", "active") == 0) ?
											$("#tabs").tabs("option", "active", 1) :
											$("#tabs").tabs("option", "active", $("#tabs").tabs("option", "active")-1)));
							break;
						case 39:		// Right arrow
							$("#tabs").tabs("option", "active",
									(($("#tabs").tabs("option", "active") == 1) ?
											$("#tabs").tabs("option", "active", 0) :
											$("#tabs").tabs("option", "active", $("#tabs").tabs("option", "active")+1)));
							break;
						// Note: up=38, down=40
						default:
							return;
					}
					e.preventDefault();
				}
			}
			document.onkeydown = checkKey;

		</script>
		<style type="text/css">
			html {
				height: 100%;
				width: 100%;
			}

			.book { font-size:xx-large; font-weight:bold; }
			.chapter { font-size:x-large; font-weight:bold; }
			.subtitle { font-size:medium; font-weight:normal; font-style:italic; }
			.category { font-size:medium; font-weight:normal; }
			.superscription { font-size:medium; font-weight:normal; font-style:italic; }
			.colophon { font-size:medium; font-weight:normal; font-style:italic; }

			.selected { background:LightGoldenRodYellow; }

			#output {
				width: 500px;
				height: 75px;
			}
			#searchPhrase {
				width: 500px;
				margin: 0 10px 0 0;
			}
			#searchResults {
				list-style-type: none;
				width: 90%;
				min-height: 300px;
				max-height: auto;
			}
			#scriptureText {
				width: 90%;
				min-height: 300px;
				max-height: auto;
				margin: 0 auto;
			}
		</style>
	</head>
	<body>
		<div id="status">
			<h1>King James Pure Bible Search</h1>
			<h2>Standalone Server</h2>
			<textarea id="output"></textarea><br />
		</div>

		<div id="tabs">
			<ul>
				<li><a href="#search"><span>Search</span></a></li>
				<li><a href="#browser"><span>Scripture Browser</span></a></li>
			</ul>

			<div id="search">
				<input id="searchPhrase" type="text" onchange="javascript:searchPhraseChanged();" />
				<ol id="searchResults"></ol>
			</div>

			<div id="browser">
				<div id="scriptureText">
				</div>
			</div>
		</div>

		<script>
		$( "#tabs" ).tabs();
		</script>


	</body>
</html>
